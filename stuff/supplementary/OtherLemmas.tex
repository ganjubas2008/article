\begin{lemma} \label{lem:rho}
    \begin{align}
        \frac{1}{M} \summ{m=1}{M} \E \norm{\mc{g}^m_t - g^m_t}^2
        &\leq
        \sigma^2 + 2 \rho L (\bar{F}_t - F_*)
    \end{align}
\end{lemma}
\begin{proof}
    \begin{align}
        \frac{1}{M} \summ{m=1}{M} \E \norm{\mc{g}^m_t - g^m_t}^2
        &\overset{~\ref{ass:ass_2}}{\leq}
        \sigma^2 + \frac{\rho}{M} \summ{m=1}{M} \norm {g^m_t}^2 \\
        &=
        \sigma^2 + \frac{\rho}{M} \summ{m=1}{M} \norm {\nabla F(x^m_t) - \nabla F(x_*)}^2 \\
        &\leq
        \sigma^2 + \frac{2 \rho L}{M} \summ{m=1}{M} {F(x^m_t) - F_*} \\
        &\leq 
        \sigma^2 + 2 \rho L (\bar{F}_t - F_*)
    \end{align}
\end{proof}


\begin{lemma} \label{lem:var_red}
    Variance reduction:
    \begin{align}
        \E \norm{\bar{\mc{g}}_t - \bar{g}_t}^2 
        \leq 
        \frac{\sigma^2}{M} + \frac{2 \rho L }{M}(\bar{F}_t - F_*)
    \end{align}
\end{lemma}
\begin{proof} In the first equality we use that $g^m_t$ on each device are independent, and in the second inequality we use Lemma~\ref{lem:rho}.
    \begin{align}
        \E \norm{\bar{\mc{g}}_t - \bar{g}_t}^2 
        &\leq 
        \E \norm{\fsumm{m=1}{M}{\mc{g}^m_t - g^m_t}}^2 \\
        &=
        \frac{1}{M^2} \summ{m=1}{M} \E \norm{\mc{g}^m_t - g^m_t}^2 \\
        &\leq
        \frac{\sigma^2}{M} + \frac{2 \rho L }{M}(\bar{F}_t - F_*)
    \end{align}
\end{proof}



\begin{lemma} \label{lem:lemma_Vt}
    \begin{align}
        \E [V_t] 
        \leq
        (H-1) \gamma^2 \sigma^2 + 2 \rho (H-1) \gamma^2 L^2 \norm{r_0}^2
    \end{align}
\end{lemma}
\begin{proof}
    We repeat the proof of Lemma 1 from \cite{Khaled} but under Assumption~\ref{ass:ass_2}.

    For $t \in \mathbb{N}$ we have $x^m_{t+1} = x^m_t - \gamma \mc{g}^m_t$ 
    and $\bar{x}_{t+1} = \bar{x}_t - \gamma \mc{\bar{g}}_t$
    if $t + 1 \mod H \neq 0$. 
    
    Hence for such $t$ and for conditioned expectation it is true that:

    \begin{align}
        \E \norm{x^m_{t+1} - \bar{x}_{t+1}}^2 
        &= \norm{x^m_t - \bar{x}_t}^2 + \gamma^2 \E \norm{\mc{g}^m_t - \mc{g}_t}^2 - 2\gamma \E [\inner{x^m_t - \bar{x}_t}{\mc{g}^m_t - \mc{g}_t}] \\
        &= \norm{x^m_t - \bar{x}_t}^2 + \gamma^2 \E \norm{\mc{g}^m_t - \mc{g}_t}^2 - 2\gamma \inner{x^m_t - \bar{x}_t}{g^m_t} + 2\gamma \inner {x^m_t - \bar{x}_t}{g_t}
    \end{align}

    Averaging over $m$:

    \begin{align}
        \E [V_{t+1}] 
        &=
        V_t + \frac{\gamma^2}{M} \summ{m=1}{M} \E \norm{\mc{g}^m_t - \mc{g}_t}^2 - \frac{2\gamma}{M} \summ{m=1}{M} \inner{x^m_t - \bar{x}_t}{g^m_t} + 2\gamma \inner {\bar{x}_t - \bar{x}_t}{g_t}  \\
        &=
        V_t + \frac{\gamma^2}{M} \summ{m=1}{M} \E \norm{\mc{g}^m_t - \mc{g}_t}^2 - \frac{2\gamma}{M} \summ{m=1}{M} \inner{x^m_t - \bar{x}_t}{g^m_t} \label{eq:1904_4}
    \end{align}

    By expanding square:

    \begin{align} 
        \E \norm{\mc{g}^m_t - \mc{g}_t}^2
        &= \E \norm{\mc{g}^m_t - g_t + g_t - \mc{g}_t}^2 \\
        &= 
        \E \norm{\mc{g}^m_t - g_t}^2 + \E \norm{\mc{g}_t - g_t}^2 + 2\E [\inner{\mc{g}^m_t - g_t}{g_t - \mc{g}_t}] \label{eq:1904_1}
    \end{align}

    And again:

    \begin{align}
        \E \norm{\mc{g}^m_t - g_t}^2 
        &= \E \norm{\mc{g}^m_t - g^m_t + g^m_t - g_t}^2 \\
        &= \E \norm{\mc{g}^m_t - g^m_t}^2 
        + \norm{g^m_t - g_t}^2
        + 2\E[\inner{\mc{g}^m_t - g^m_t}{g^m_t - g_t}] \\
        &= \E \norm{\mc{g}^m_t - g^m_t}^2 
        + \norm{g^m_t - g_t}^2
        + 2 \inner{g^m_t - g^m_t}{g^m_t - g_t} \\
        &= \E \norm{\mc{g}^m_t - g^m_t}^2 
        + \norm{g^m_t - g_t}^2 \label{eq:1904_2}
    \end{align}

    Combining \eqref{eq:1904_1} and \eqref{eq:1904_2} we have:

    \begin{align}
        \E \norm{\mc{g}^m_t - \mc{g}_t}^2
        &= \E \norm{\mc{g}^m_t - g^m_t}^2 
        + \norm{g^m_t - g_t}^2 + \E \norm{\mc{g}_t - g_t}^2 + 2\E [\inner{\mc{g}^m_t - g_t}{g_t - \mc{g}_t}]
    \end{align}

    By averaging both sides over $m$:

    \begin{align}
        \fsumm{m=1}{M} \E \norm{\mc{g}^m_t - \mc{g}_t}^2
        &= \fsumm{m=1}{M} \E \norm{\mc{g}^m_t - g^m_t}^2 
        + \fsumm{m=1}{M} \norm{g^m_t - g_t}^2 \\
        &+ \E \norm{\mc{g}_t - g_t}^2 
        + 2\E [\inner{\mc{g}_t - g_t}{g_t - \mc{g}_t}] \\
        &= \fsumm{m=1}{M} \E \norm{\mc{g}^m_t - g^m_t}^2 
        + \fsumm{m=1}{M} \norm{g^m_t - g_t}^2 \\
        &+ \E \norm{\mc{g}_t - g_t}^2 
        - 2\E \norm{\mc{g}_t - g_t}^2 \\
        &= \fsumm{m=1}{M} \E \norm{\mc{g}^m_t - g^m_t}^2 
        + \fsumm{m=1}{M} \norm{g^m_t - g_t}^2
        - \E \norm{\mc{g}_t - g_t}^2 \\
        &\leq \fsumm{m=1}{M} \E \norm{\mc{g}^m_t - g^m_t}^2 
        + \fsumm{m=1}{M} \norm{g^m_t - g_t}^2 \label{eq:1904_3}
    \end{align}

    We can estimate second term here as follows:
    \begin{align}
        \fsumm{m=1}{M} \norm{g^m_t - g_t}^2 
        &=
        \fsumm{m=1}{M} \norm{g^m_t - \nabla F(\bar{x}_t) + \nabla F(\bar{x}_t) - g_t}^2 \\
        &=
        \fsumm{m=1}{M} \left( \norm{g^m_t - \nabla F(\bar{x}_t)}^2 + \norm{\nabla F(\bar{x}_t) - g_t}^2 + 2 \inner{g^m_t - \nabla F(\bar{x}_t)}{\nabla F(\bar{x}_t) - g_t} \right) \\
        &= 
        \fsumm{m=1}{M} \norm{g^m_t - \nabla F(\bar{x}_t)}^2 + \norm{\nabla F(\bar{x}_t) - g_t}^2 - 2 \norm{\nabla F(\bar{x}_t) - g_t}^2 \\
        &= 
        \fsumm{m=1}{M} \norm{g^m_t - \nabla F(\bar{x}_t)}^2 - \norm{\nabla F(\bar{x}_t) - g_t}^2 \\
        &\leq 
        \fsumm{m=1}{M} \norm{g^m_t - \nabla F(\bar{x}_t)}^2
        =
        \fsumm{m=1}{M} \norm{\nabla F(x^m_t) - \nabla F(\bar{x}_t)}^2 \\
        &\overset{~\ref{cor:nesterov}}{\leq}
        \fsumm{m=1}{M} 2L (F(\bar{x}_t) - F(x^m_t) - \inner{\bar{x}_t - x^m_t}{\nabla F(x^m_t)}) \\
        &=
        \frac{2L}{M} \summ{m=1}{M} \inner{x^m_t - \bar{x}_t}{\nabla F(x^m_t)}
        - 2L (\bar{F}_t-F(\bar{x}_t)) \label{eq:2004_1}
    \end{align}

    Substituting \eqref{eq:2004_1} into \eqref{eq:1904_3} and bounding variance:

    \begin{align}
        \fsumm{m=1}{M} \E \norm{\mc{g}^m_t - \mc{g}_t} 
        &\leq
        \fsumm{m=1}{M} \E \norm{\mc{g}^m_t - g^m_t}^2 
        - 
        2L (\bar{F}_t-F(\bar{x}_t))
        +
        \frac{2L}{M} \summ{m=1}{M} \inner{x^m_t - \bar{x}_t}{\nabla F(x^m_t)} \\
        &\overset{~\ref{lem:rho}}{\leq}
        \sigma^2 + 2 \rho L (\bar{F}_t - F_*) 
        - 
        2L (\bar{F}_t-F(\bar{x}_t))
        +
        \frac{2L}{M} \summ{m=1}{M} \inner{x^m_t - \bar{x}_t}{\nabla F(x^m_t)} \\
        &=
        \sigma^2 + 2 L (\rho - 1) (\bar{F}_t - F_*) 
        +
        \frac{2L}{M} \summ{m=1}{M} \inner{x^m_t - \bar{x}_t}{\nabla F(x^m_t)}
    \end{align}

    Let us substitute this result into \eqref{eq:1904_4}:

    \begin{align}
        \E [V_{t+1}] 
        &=
        V_t + \frac{\gamma^2}{M} \summ{m=1}{M} \E \norm{\mc{g}^m_t - \mc{g}_t}^2 - \frac{2\gamma}{M} \summ{m=1}{M} \inner{x^m_t - \bar{x}_t}{\nabla F(x^m_t)} \\
        &\leq 
        V_t 
        +\gamma^2 \sigma^2 
        +2 \gamma^2 L (\rho - 1) (\bar{F}_t - F_*) \\
        &+\frac{2 \gamma^2 L}{M} \summ{m=1}{M} \inner{x^m_t - \bar{x}_t}{\nabla F(x^m_t)}
        - \frac{2\gamma}{M} \summ{m=1}{M} \inner{x^m_t - \bar{x}_t}{\nabla F(x^m_t)} \\
        &=
        V_t 
        +\gamma^2 \sigma^2 
        +2 \gamma^2 L (\rho - 1) (\bar{F}_t - F_*)
        - \frac{2\gamma}{M}(1 - \gamma L) \summ{m=1}{M} \inner{x^m_t - \bar{x}_t}{\nabla F(x^m_t)}
        \label{eq:1904_5}
    \end{align}

    Now let us analyize last term. We know that $\gamma \leq \frac{1}{6L}$, therefore $1 - \gamma L \geq 0$. Thus, by strong convexity:

    \begin{align}
    &- \frac{2\gamma}{M}(1 - \gamma L) \summ{m=1}{M} \inner{x^m_t - \bar{x}_t}{\nabla F(x^m_t)} 
    =
    \frac{2\gamma}{M}(1 - \gamma L) \summ{m=1}{M} \inner{\bar{x}_t - x^m_t}{\nabla F(x^m_t)} \\
    &\overset{~\ref{ass:ass_1}}{\leq}
    \frac{2\gamma}{M}(1 - \gamma L) \summ{m=1}{M} \left(F(\bar{x}_t) - F(x^m_t) - \frac{\mu}{2} \norm{x^m_t - \bar{x}_t}^2 \right) \\
    &=
    \frac{2\gamma}{M}(1 - \gamma L) \summ{m=1}{M} \left( F(\bar{x}_t) - F(x^m_t) \right)
    - \frac{\gamma}{M}(1 - \gamma L) \summ{m=1}{M} \mu \norm{x^m_t - \bar{x}_t}^2 \\
    &=
    - 2\gamma (1-\gamma L) (\bar{F}_t - F(\bar{x}_t)) - \gamma (1 - \gamma L) \mu V_t
    \label{eq:1904_6}
    \end{align}

    Plugging \eqref{eq:1904_6} into \eqref{eq:1904_5} and again using that $\gamma \leq \frac{1}{6L}$:

    \begin{align}
        \E [V_{t+1}]
        &\leq
        V_t 
        + \gamma^2 \sigma^2 
        + 2 \gamma^2 L (\rho - 1) (\bar{F}_t - F_*)
        - 2\gamma (1-\gamma L) (\bar{F}_t - F(\bar{x}_t)) - \gamma (1 - \gamma L) \mu V_t \\
        &=
        (1 - \gamma (1 - \gamma L) \mu) V_t
        + \gamma^2 \sigma^2 
        + 2 \gamma^2 L (\rho - 1) (\bar{F}_t - F_*)
        - 2\gamma (1-\gamma L) (\bar{F}_t - F(\bar{x}_t)) \\
        &\leq
        (1 - \frac {\gamma \mu}{6}) V_t
        + \gamma^2 \sigma^2 
        + 2 \gamma^2 L (\rho - 1) (\bar{F}_t - F_*)
        - 2\gamma (1-\gamma L) (\bar{F}_t - F(\bar{x}_t))
        \label{eq:1904_7} 
    \end{align}

    Now let us do some algebraic manipulations with last two terms:

    \begin{align}
        2 \gamma^2 L (\rho - 1) & (\bar{F}_t - F_*)
        - 2\gamma (1-\gamma L) (\bar{F}_t - F(\bar{x}_t)) \\
        &=
        2 \gamma^2 L \rho (\bar{F}_t - F_*)
        - 2 \gamma^2 L (\bar{F}_t - F_*) \\
        &- 2\gamma (\bar{F}_t - F(\bar{x}_t))
        + 2\gamma^2 L (\bar{F}_t - F(\bar{x}_t)) \\
        &=
        2 \gamma^2 L \rho (\bar{F}_t - F_*)
        + 2 \gamma^2 L F_* \\
        &- 2\gamma (\bar{F}_t - F(\bar{x}_t))
        - 2\gamma^2 L F(\bar{x}_t)
    \end{align}

    Let us divide $t$ by $H$, suppose $t = kH + 1 + a; \ k, a \in \mathbb{N}; \ a < H$.
    Recalling that $V_{kH + 1} = 0$, recursing \eqref{eq:1904_7} and considering $\E$ as a full expectation yields:
    
    \begin{align}
        \E [V_{t}]
        &\leq
        (1 - \frac{\gamma \mu}{12})^a  \cdot V_{kH + 1} 
        +
        \summ{j=kH + 1}{kH+a}
        (1 - \frac{\gamma \mu} {12})^{(t-j)}
        \cdot
        \left(
        \rho \gamma^2 L^2 \E \norm{r_j}^2 + \gamma^2 \sigma^2
        \right) \\
        &=
        \summ{j=kH + 1}{kH+a}
        (1 - \frac{\gamma \mu} {12})^{(t-j)}
        \cdot 
        \left(
        \rho \gamma^2 L^2 \E \norm{r_j}^2 + \gamma^2 \sigma^2
        \right) \\
        &\leq
        a \gamma^2 \sigma^2 +
        \summ{j=kH + 1}{kH+a}
        (1 - \frac{\gamma \mu} {12})^{(t-j)}
        \cdot \rho \gamma^2 L^2 \E \norm{r_j}^2 \\
        &\overset{Magic}{\leq}
        a \gamma^2 \sigma^2 + a \rho \gamma^2 L^2 \E \norm{r_t}^2 
        \leq 
        (H-1) \gamma^2 \sigma^2 + (H-1) \rho \gamma^2 L^2 \E \norm{r_t}^2 
    \end{align}
     
\end{proof}



\begin{lemma}\label{lem:very_main}
    For $\gamma \leq \frac{1}{6L}$:
    \begin{align}
        \begin{split}
            \E \norm{\bar{x}_{t+1}-x_*}^2
            &\leq
            (1 - \gamma \mu) \E \norm{\bar{x}_t - x_*}^2 
            + \frac{\gamma^2 \sigma^2}{M} + \frac{2 \gamma^2 \rho L^2}{M}  (H-1) \left(\gamma^2 \sigma^2 + 2 \rho \gamma^2 L^2 \norm{r_t}^2 \right)  \\
            &+ \frac{2 \gamma^2 \rho L^2}{M} \E \norm{r_t}^2
            - \frac{\gamma}{5} \E [F(\bar{x}_t) - F_*] 
            + 10 \gamma^3 L_R (H-1) \left(\sigma^2 + 2 \rho L^2 \norm{r_t}^2 \right) \\
            &\leq
            \left(1 - \gamma \mu 
            + \frac{2\gamma^4 \rho^2 H L^4}{M} 
            + \frac{2\gamma^2 \rho L^2}{M}
            + 20 \gamma^3 \rho L_R H L^2 \right) \E \norm{r_t}^2 \\
            &+ \frac{\gamma^2 \sigma^2}{M} + \frac{2\gamma^4 \rho L^2 \sigma^2 H}{M}
            + 10 \gamma^3 L_R H \sigma^2
        \end{split}
    \end{align}
\end{lemma}
\begin{proof}
    Using the update equation \eqref{eq:upd_eq} we have
    \begin{align}
        \norm{\bar{x}_{t+1}-x_*}^2
        &= \norm{\bar{x}_{t} - \gamma \bar {\mc{g_t}} - x_*}^2
        = \norm{\bar{x}_{t} - \gamma \bar {\mc{g_t}} - x_* - \gamma \bar{g}_t + \gamma \bar{g}_t}^2 \\
        &= \norm{\bar{x}_t - x_* - \gamma \bar{g}_t}^2 
        + \gamma^2 \norm{\bar {\mc{g_t}} - \bar{g}_t}^2
        + 2 \gamma \inner{\bar{x}_t - x_* - \gamma \bar{g}_t}{\bar {\mc{g_t}} - \bar{g}_t}
    \end{align}
    
    Taking expectation, 
    \begin{align}
        \E \norm{\bar{x}_{t+1}-x_*}^2
        &= \E \norm{\bar{x}_t - x_* - \gamma \bar{g}_t}^2
        + \gamma^2 \E \norm{ \bar {\mc{g_t}} - \bar{g}_t}^2 \label{eq:eq81}
    \end{align}
    
    
    Taking expectiation of result of Lemma~\ref{lem:main}:
    \begin{align}
        \E \norm{\bar{x}_t - x_* - \gamma \bar{g}_t}^2 
        &\leq (1 - \gamma \mu) \E \norm{\bar{x}_t - x_*}^2 
        - \frac{\gamma}{5} \E [F(\bar{x}_t) - F_*] 
        + 10 \gamma L_R \E [V_t] \label{eq:eq82}
    \end{align}

    Combining \eqref{eq:eq81} with Lemma~\ref{lem:var_red} and Lemma~\ref{lem:lemma_Vt}
    \begin{align}
         \E \norm{\bar{x}_{t+1}-x_*}^2
        &\leq (1 - \gamma \mu) \E \norm{\bar{x}_t - x_*}^2 
        + \gamma^2 \E \norm{ \bar{\mc{g_t}} - \bar{g}_t}^2
        - \frac{\gamma}{5} \E [F(\bar{x}_t) - F_*] 
        + 10 \gamma L_R \E [V_t] \\
        &\leq
        (1 - \gamma \mu) \E \norm{\bar{x}_t - x_*}^2 
        + \frac{\gamma^2 \sigma^2}{M}
        - \frac{\gamma}{5} \E [F(\bar{x}_t) - F_*] 
        + 10 \gamma L_R (H-1) \gamma^2 \sigma^2
    \end{align}
\end{proof}